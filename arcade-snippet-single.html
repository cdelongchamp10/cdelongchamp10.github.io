<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Arcade Expression — Feature/Table Join</title>
  <meta name="description" content="Self-contained single-file snippet page for embedding in ArcGIS Experience Builder.">
  <style>
    :root{
      --bg:#0b1320; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:rgba(148,163,184,.18);
      --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    header{padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(148,163,184,.08),rgba(15,23,42,.6))}
    h1{font-size:18px;margin:0 0 4px;letter-spacing:.3px}
    .meta{font-size:13px;color:var(--muted)}
    main{max-width:1100px;margin:0 auto;padding:22px 16px 40px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    pre{margin:0;padding:16px 18px;overflow:auto;border-radius:12px;line-height:1.5;font-size:14px;background:transparent}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;tab-size:2;white-space:pre}
    .tip{color:var(--muted);margin-top:10px;font-size:13px}
    footer{color:var(--muted);font-size:12px;padding:12px 16px 26px;text-align:center}
    /* Token colors */
    .tok-comment{color:#9ca3af;font-style:italic}
    .tok-string{color:#fcd34d}
    .tok-number{color:#fca5a5}
    .tok-key{color:#93c5fd}
    .tok-func{color:#86efac}
    .tok-type{color:#a5b4fc}
  </style>
</head>
<body>
  <header>
    <h1>Arcade Expression — Feature/Table Join</h1>
  </header>
  <main>
    <div class="card">
      <pre id="code"><code>// This expression joins features from a feature service and table, the services are joined using a primary (feautreservice) and foreign (table) key --- creating one table
// Attributes must be explicitly defined. Replace all items with the ✏️ symbol next to them.  

var portal = Portal("https://maps.test.cce.af.mil/soe");

// Source feature layer 
var FL = FeatureSetByPortalItem(
  portal,
  "c8384d02df774ff6b3447a38f8f87fb9", //  ✏️ replace item ID
  0,                                  //  ✏️ replace layer ID (if needed)
  ["specieslocationidpk",             //  ✏️ list fields to add from the source layer
   "country"
  ]
);

// Standalone table
var TBL = FeatureSetByPortalItem(
  portal,
  "52e8674d7617470f8111f3257bf68476", // ✏️ replace item ID
  0,                                  // ✏️ replace layer ID (if needed)
  [
    "specieslocationidfk",            // ✏️ list fields to add from table
    "treenotes",
    "dbh",
    "treeconditionclass",
    "primarymaintenanceneed",
    "plantingsitepriority",
    "treecode",
    "treelocationtype"
  ]
);

// Define output schema (no geometry) ✏️ list all fields and schema type
var outFields = [
  {"name":"specieslocationidpk", "type":"esriFieldTypeString"},
  {"name":"country",             "type":"esriFieldTypeString"},
  {"name":"treenotes",           "type":"esriFieldTypeString"},
  {"name":"dbh",                 "type":"esriFieldTypeInteger"},
  {"name":"treeconditionclass",  "type":"esriFieldTypeString"},
  {"name":"primarymaintenanceneed","type":"esriFieldTypeString"},
  {"name":"plantingsitepriority","type":"esriFieldTypeString"},
  {"name":"treecode",            "type":"esriFieldTypeString"},
  {"name":"treelocationtype",    "type":"esriFieldTypeString"},
  {"name":"join_text",           "type":"esriFieldTypeString"} 
];

var schema = {
  "fields": outFields,
  "geometryType": "",
  "features": []
};

// Build output features (loops through all features in var id, finds all features in table with the matching foreign key - return their attributes 
for (var f in FL) {
  var id = f.specieslocationidpk; // ✏️ primary key from feature layer
  if (IsEmpty(id)) { continue; }

  var rel = First(Filter(TBL, "specieslocationidfk = @id")); // ✏️ foreign key from table

  function show(v) { return IIf(IsEmpty(v), "—", v); }

  var attrs = {  // ✏️ edit which attributes from both services to be displayed in the joined table
    "specieslocationidpk": id,
    "country":           f.country,
    "treenotes":           IIf(IsEmpty(rel), null, rel.treenotes),
    "dbh":                 IIf(IsEmpty(rel), null, rel.dbh),
    "treeconditionclass":  IIf(IsEmpty(rel), null, rel.treeconditionclass),
    "primarymaintenanceneed": IIf(IsEmpty(rel), null, rel.primarymaintenanceneed),
    "plantingsitepriority":IIf(IsEmpty(rel), null, rel.plantingsitepriority),
    "treecode":            IIf(IsEmpty(rel), null, rel.treecode),
    "treelocationtype":    IIf(IsEmpty(rel), null, rel.treelocationtype),
  };

  Push(schema.features, {"attributes": attrs});
}

// Return a FeatureSet
return FeatureSet(Text(schema));</code></pre>
    </div>
    <p class="tip">If your org blocks inline scripts, this will still render the code (without colors). Otherwise, inline highlighter below will add colors.</p>
  </main>
  <footer>© Developer Templates</footer>

  <script>
    // Inline mini-highlighter. Remove this block if inline scripts are blocked by CSP.
    (function(){
      var el = document.getElementById('code');
      var html = el.innerHTML;

      function wrap(pattern, cls){
        html = html.replace(pattern, function(m){ return '<span class="'+cls+'">'+m.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</span>'; });
      }

      // Escape first to avoid breaking markup
      html = html
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');

      // Tokenization (order matters)
      // comments
      html = html.replace(/(^|\s)\/\/.*$/gm, function(m){ return '<span class="tok-comment">'+m+'</span>'; });
      // strings
      html = html.replace(/'[^'\n]*'|"[^"\n]*"/g, function(m){ return '<span class="tok-string">'+m+'</span>'; });
      // numbers
      html = html.replace(/\b(\d+(\.\d+)?)\b/g, '<span class="tok-number">$1</span>');
      // keywords
      html = html.replace(/\b(var|let|const|function|return|if|else|for|in|continue|break|true|false|null|new)\b/g, '<span class="tok-key">$1</span>');
      // common Arcade/JS funcs
      html = html.replace(/\b(Portal|FeatureSetByPortalItem|FeatureSet|Filter|First|IIf|IsEmpty|Push|Text)\b/g, '<span class="tok-func">$1</span>');
      // esri types
      html = html.replace(/\b(esriFieldTypeString|esriFieldTypeInteger|geometryType|fields|features)\b/g, '<span class="tok-type">$1</span>');

      el.innerHTML = html;
    })();
  </script>
</body>
</html>
