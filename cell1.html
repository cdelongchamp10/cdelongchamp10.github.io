# this has a few more troubleshooting steps that are removed in the final notebook. (portal login, feature service url checking)
# Cell 1 - configure services, assign join fields, connect to portal, create join (in memory)

import arcpy
import re

# -------------------
# USER SETTINGS
# -------------------
PORTAL_URL   = "https://maps.test.cce.af.mil/soe"  # Your portal URL
PORTAL_USER  = "cdelongchamp"                      # Your username
PORTAL_PASS  = "12qwaszx!@QWASZX"                  # Your password

# Hosted Feature Service (rest endpoint of feature service)
FEATURE_SERVICE_INPUT = r"https://maps.test.cce.af.mil/soe/rest/services/Hosted/Species_Location_Point_Fictional_Data_1/FeatureServer"
DEFAULT_LAYER_ID = 0  # If root URL given, use this layer

# FGDB table path (local path to the FGDB with table to join to feature service)
FGDB_TABLE_PATH = r"C:\Users\cod11939\Desktop\AFGIMS\AFGIMS Join With Data\UrbanTreeInventoryInfo_Fictional_Table\_ags_dataC30F638EC5E24828BC8B7D014A80CFFD.gdb\UrbanTreeInventoryIn"

# Join fields
FEATURE_JOIN_FIELD = "specieslocationidpk"       # Enter join field key
TABLE_JOIN_FIELD   = "specieslocationidfk"       # Enter join field key

# -------------------
# FUNCTIONS
# -------------------
def ensure_layer_url(url_or_item, default_layer_id=0):
    """Ensure we have a FeatureServer/<layerId> URL, not just the root."""
    s = url_or_item.strip()
    if re.search(r"/FeatureServer/\d+$", s, re.IGNORECASE):
        return s
    if re.search(r"/FeatureServer/?$", s, re.IGNORECASE):
        return s.rstrip("/") + f"/{default_layer_id}"
    if re.search(r"/MapServer", s, re.IGNORECASE):
        raise ValueError("Input points to a MapServer. Use a FeatureServer layer URL instead.")
    return s

# -------------------
# CONNECT TO PORTAL
# -------------------
if PORTAL_USER and PORTAL_PASS:
    arcpy.SignInToPortal(PORTAL_URL, PORTAL_USER, PORTAL_PASS)
    print(f"Signed in to {PORTAL_URL}")
else:
    print("Using current ArcGIS Pro portal session.")

# -------------------
# SAFE REFRESH: clear only in-memory GP objects
# -------------------
for obj in ("feature_lyr", "table_view"):
    try:
        arcpy.management.Delete(obj)
        print(f"Deleted in-memory object: {obj}")
    except Exception:
        pass

# -------------------
# CREATE LAYER + TABLE VIEW
# -------------------
feature_layer_url = ensure_layer_url(FEATURE_SERVICE_INPUT, DEFAULT_LAYER_ID)
print(f"Using layer URL: {feature_layer_url}")

# Hosted feature service → Feature Layer
arcpy.management.MakeFeatureLayer(feature_layer_url, "feature_lyr")
print("Feature layer created: feature_lyr")

# FGDB table → Table View
arcpy.management.MakeTableView(FGDB_TABLE_PATH, "table_view")
print("Table view created: table_view")

# -------------------
# ADD JOIN
# -------------------
print("Adding join...")
arcpy.management.AddJoin(
    in_layer_or_view="feature_lyr",
    in_field=FEATURE_JOIN_FIELD,
    join_table="table_view",
    join_field=TABLE_JOIN_FIELD,
    join_type="KEEP_ALL",
    index_join_fields="NO_INDEX_JOIN_FIELDS",
    rebuild_index="NO_REBUILD_INDEX",
    join_operation="JOIN_ONE_TO_FIRST"
)
print("✅ Join complete (in memory). You can now export if needed.")
